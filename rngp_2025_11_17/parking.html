<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—à–∏–Ω–æ–º–µ—Å—Ç</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <style>
        fieldset { margin-bottom: 2rem; }
        legend { font-size: 1.2rem; color: var(--primary); }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –ì–ò–° –∞–¥—Ä–µ—Å–∞ */
        #fullAddressRow {
            margin-bottom: 1rem; 
            padding: 0.75rem; 
            background: #f0f2f5; 
            border-radius: 8px; 
            border-left: 4px solid #10adff;
            font-size: 0.9rem;
        }
        #fullAddressOutput { font-weight: 600; color: #333; }

        #yandexLinkContainer { margin-bottom: 1.5rem; }
        
        .yandex-card {
            padding: 1rem;
            background: #f8f9fa;
            border: 1px dashed #bbc1c7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .yandex-btn {
            background-color: #ffcc00 !important;
            color: #000 !important;
            border: none !important;
            padding: 8px 16px !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            border-radius: 6px !important;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>

<main class="container">
    <article>
        <header>
            <h2 style="margin:0">–í–≤–æ–¥ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</h2>
        </header>

        <form id="parkingForm">
            <fieldset>
                <legend><strong>1. –û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ</strong></legend>
                
                <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
                    <input type="text" id="objName" placeholder="–ù–∞–ø—Ä: –∂–∏–ª–æ–π –∫–æ—Ä–ø—É—Å 1">
                </label>

                <label>–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É
                    <input type="text" id="objAddress" placeholder="–ù–∞–ø—Ä: —É–ª. –ú–∞—Ä—à–∞–ª–∞ –ö–∞—Ç—É–∫–æ–≤–∞, 24">
                    <small>–†–∞–π–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ –∞–¥—Ä–µ—Å–∞</small>
                </label>

                <div id="fullAddressRow">
                    <small style="color: #666; display: block; margin-bottom: 2px;">–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ (–ø–æ–ª—É—á–µ–Ω –ø–æ –ì–ò–°):</small>
                    <div id="fullAddressOutput">–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞...</div>
                </div>

                <div id="yandexLinkContainer"></div>

                <div class="grid">
                    <label for="districtSelect">–†–∞–π–æ–Ω –ú–æ—Å–∫–≤—ã
                        <select id="districtSelect" onchange="calculate()">
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω...</option>
                        </select>
                    </label>
            
                    <label for="ttkPos">–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¢–¢–ö
                        <select id="ttkPos" onchange="calculate()">
                            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –æ–ø—Ü–∏–∏ -->
                        </select>
                    </label>
                </div>
            
                <div class="grid">
                    <label for="metroAccess">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–æ/–ú–¶–ö/–ú–¶–î
                        <select id="metroAccess" onchange="calculate()"></select>
                    </label>
                
                    <label for="rnsYear">–ì–æ–¥ –†–ù–°
                        <select id="rnsYear" onchange="calculate()">
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥...</option>
                        </select>
                    </label>
                </div>
            </fieldset>

            <fieldset>
                <legend><strong>2. –¢–µ—Ö–Ω–∏–∫–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–¢–≠–ü)</strong></legend>
                <div class="grid">
                    <label>–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞, –∫–≤.–º
                        <input type="number" id="areaSite" value="0" step="0.01" oninput="calculate()">
                    </label>
                    <label>–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä (S–æ–±.–∫–≤.), –∫–≤.–º
                        <input type="number" id="areaFlats" value="0" step="0.1" oninput="calculate()">
                    </label>
                </div>
                <div class="grid">
                    <label>–ü–ª–æ—â–∞–¥—å –ù–ü–ö–ò (S–Ω–ø–∫–∏), –∫–≤.–º
                        <input type="number" id="areaNPKI" value="0" step="0.1" oninput="calculate()">
                    </label>
                    <label>–ü–ª–æ—â–∞–¥—å –ù–ù–ü, –∫–≤.–º
                        <input type="number" id="areaNNP" value="0" step="0.1" oninput="calculate()">
                    </label>
                </div>
                <!-- –∏–º—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞? -->
                <div class="grid">

                    <label>–£–¥. –∂–∏–ª. –æ–±–µ—Å–ø. (–∫–≤.–º/—á–µ–ª)
                        <input type="number" id="specLiving" value="28" oninput="calculate()">
                    </label>
                    <label>–°–æ—Ç—Ä./–ø–æ—Å. –ù–ü–ö–ò (–∫–≤.–º/—á–µ–ª)
                        <input type="number" id="specStaff" value="20" oninput="calculate()">
                    </label>
                </div>
            </fieldset>

            <fieldset>
                <legend><strong>3. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ —Å—Ç–æ—è–Ω–∫–∏ (–º/–º)</strong></legend>
                <div class="grid">
                    <div>
                        <small><strong>–ù–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ —É—á–∞—Å—Ç–∫–∞ (–ó–£):</strong></small>
                        <input type="number" id="fact_zu_mo" placeholder="–ú–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏" value="0" oninput="calculate()">
                        <input type="number" id="fact_zu_guest_mgn" placeholder="–ì–æ—Å—Ç–µ–≤—ã–µ –ú–ì–ù" value="0" oninput="calculate()">
                        <input type="number" id="fact_zu_priob_mgn" placeholder="–ü—Ä–∏–æ–±—ä–µ–∫—Ç–Ω—ã–µ –ú–ì–ù" value="0" oninput="calculate()">
                    </div>
                    <div>
                        <small><strong>–ù–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –£–î–°:</strong></small>
                        <input type="number" id="fact_uds_mo" placeholder="–ú–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫" value="0" oninput="calculate()">
                        <div class="grid">
                            <input type="number" id="fact_uds_guest" placeholder="–ì–æ—Å—Ç." value="0" oninput="calculate()">
                            <input type="number" id="fact_uds_guest_mgn" placeholder="–ì–æ—Å—Ç. –ú–ì–ù" value="0" oninput="calculate()">
                        </div>
                        <div class="grid">
                            <input type="number" id="fact_uds_priob" placeholder="–ü—Ä–∏–æ–±." value="0" oninput="calculate()">
                            <input type="number" id="fact_uds_priob_mgn" placeholder="–ü—Ä–∏–æ–±. –ú–ì–ù" value="0" oninput="calculate()">
                        </div>
                    </div>
                </div>
            </fieldset>
        </form>
            <section id="parkingResults" style="margin-top:2rem;">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞ –º–∞—à–∏–Ω–æ–º–µ—Å—Ç</h3>
                <div id="parkingResultsContent">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞.</div>
            </section>
    </article>
</main>

<script src="parkingData.js" defer></script>
<script src="parkingEngine.js" defer></script>
<script src="mainEngine.js" defer></script>

<script>
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ (–±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π)
    async function calculate() {
        const district = document.getElementById('districtSelect')?.value;
        console.log("üìä === –¢–†–ò–ì–ì–ï–† –†–ê–°–ß–ï–¢–ê ===");
        console.log("–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–π–æ–Ω:", district || "–Ω–µ –≤—ã–±—Ä–∞–Ω");
        console.log("üìä === –ö–û–ù–ï–¶ –¢–†–ò–ì–ì–ï–†–ê ===");
        await calculateParking();
    }   

    
    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ—è–Ω–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º mainEngine.js
    async function calculateParking() {
        try {
            const inputData = {
                areaFlats: parseFloat(document.getElementById('areaFlats').value) || 0,
                areaNNP: parseFloat(document.getElementById('areaNNP').value) || 0,
                specLiving: parseFloat(document.getElementById('specLiving').value) || 28,
                specStaff: parseFloat(document.getElementById('specStaff').value) || 20,
                factualPlaces: parseFloat(document.getElementById('fact_zu_mo').value) || 0,
                rnsYear: parseInt(document.getElementById(' || 0').value) || 2025
            };

            const calculator = new ParkingCalculator(inputData);
            calculator.calculate(inputData);

            const results = calculator.results;
            const calculations = calculator.calculations || [];

            // 1. –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            let inputBlock = `<h4 style='margin-top:2em;'>–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4><table><thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr></thead><tbody>`;
            const inputMap = [
                {label:'–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', key:'objType', value:'–ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π –¥–æ–º'},
                {label:'–ì–æ–¥ –†–ù–°', key:'rnsYear', value:inputData.rnsYear},
                {label:'–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞', key:'areaSite', value:inputData.areaSite},
                {label:'–ü–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä', key:'areaFlats', value:inputData.areaFlats},
                {label:'–ü–ª–æ—â–∞–¥—å –ù–ù–ü', key:'areaNNP', value:inputData.areaNNP},
                {label:'–ü–ª–æ—â–∞–¥—å –ù–ü–ö–ò', key:'areaNPKI', value:inputData.areaNPKI},
                {label:'–†–∞–π–æ–Ω', key:'district', value:document.getElementById('districtSelect')?.value},
                {label:'–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ö1', key:'k1', value:inputData.k1,
                {label:'–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ö2', key:'k2', value:inputData.k2}
            ];
            for (const row of inputMap) {
                inputBlock += `<tr><td>${row.label}</td><td>${row.key}</td><td>${row.value ?? '-'}</td></tr>`;
            }
            inputBlock += "</tbody></table>";

            // 2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã
            let mainBlock = `<h4 style='margin-top:2em;'>–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã</h4><table><thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th><th style='min-width:320px;'>–§–æ—Ä–º—É–ª–∞</th><th style='min-width:220px;'>–†–∞—Å—á—ë—Ç</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–ï–¥. –∏–∑–º.</th></tr></thead><tbody>`;
            const mainKeys = ['Np','Ng','Nv','Nk_residential','Nk_commercial','No_total','N_total','N_ev'];
            for (const calc of calculations.filter(c=>mainKeys.includes(c.id))) {
                mainBlock += `<tr>
                    <td><strong>${calc.name ?? '-'}</strong></td>
                    <td>${results[calc.id] ?? '-'}</td>
                    <td style='min-width:320px;'>${calc.formula ?? '-'}</td>
                    <td style='min-width:220px;'>${calc.calculation ?? '-'}</td>
                    <td>${calc.result ?? '-'}</td>
                    <td>${calc.unit ?? '-'}</td>
                </tr>`;
            }
            mainBlock += "</tbody></table>";

            // 3. –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
            let devBlock = '';
            const deviations = calculator.getDeviations();
            if (deviations.length) {
                devBlock += `<h4 style='margin-top:2em;'>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</h4><table><thead><tr><th>–í–∏–¥</th><th style='min-width:320px;'>–§–æ—Ä–º—É–ª–∞</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–ï–¥. –∏–∑–º.</th></tr></thead><tbody>`;
                for (const dev of deviations) {
                    devBlock += `<tr>
                        <td>${dev.name}</td>
                        <td style='min-width:320px;'>${dev.formula}</td>
                        <td>${dev.value}</td>
                        <td>${dev.unit}</td>
                    </tr>`;
                }
                devBlock += "</tbody></table>";
            }

            // 4. –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (required, min, max)
            function renderBreakdown(title, table) {
                let block = `<h4 style='margin-top:2em;'>${title}</h4><table><thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th style='min-width:340px;'>–§–æ—Ä–º—É–ª–∞ —Å –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr></thead><tbody>`;
                for (const row of table) {
                    // –§–æ—Ä–º—É–ª–∞ –∏ —Ä–∞—Å—á—ë—Ç –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏: –∏—â–µ–º –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –≤ calculations
                    const calc = calculations.find(c => row.–æ–ø–∏—Å–∞–Ω–∏–µ && c.name && c.name.includes(row.–æ–ø–∏—Å–∞–Ω–∏–µ));
                    let formulaCalc = '-';
                    if (calc) {
                        formulaCalc = `<div>${calc.formula ?? '-'}</div><div style='color:#555;font-size:0.95em;'>${calc.calculation ?? '-'}</div>`;
                    }
                    block += `<tr><td>${row.–æ–ø–∏—Å–∞–Ω–∏–µ}</td><td style='min-width:340px;'>${formulaCalc}</td><td>${row.–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}</td></tr>`;
                }
                block += "</tbody></table>";
                return block;
            }
            const breakdownTables = calculator.getAllBreakdownTables();
            let breakdownRequired = renderBreakdown('–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (—Ç—Ä–µ–±—É–µ—Ç—Å—è)', breakdownTables.required);
            let breakdownMin = renderBreakdown('–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (–º–∏–Ω–∏–º—É–º)', breakdownTables.min);
            let breakdownMax = renderBreakdown('–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (–º–∞–∫—Å–∏–º—É–º)', breakdownTables.max);

            // 5. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (—à–∫–æ–ª–∞, –¥–µ—Ç—Å–∞–¥)
            let specialBlock = `<h4 style='margin-top:2em;'>–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h4><table><thead><tr><th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th><th style='min-width:320px;'>–§–æ—Ä–º—É–ª–∞</th><th style='min-width:220px;'>–†–∞—Å—á—ë—Ç</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>–ï–¥. –∏–∑–º.</th></tr></thead><tbody>`;
            const specialKeys = ['Nk_school','Nk_preschool'];
            for (const calc of calculations.filter(c=>specialKeys.includes(c.id))) {
                specialBlock += `<tr>
                    <td><strong>${calc.name ?? '-'}</strong></td>
                    <td>${results[calc.id] ?? '-'}</td>
                    <td style='min-width:320px;'>${calc.formula ?? '-'}</td>
                    <td style='min-width:220px;'>${calc.calculation ?? '-'}</td>
                    <td>${calc.result ?? '-'}</td>
                    <td>${calc.unit ?? '-'}</td>
                </tr>`;
            }
            specialBlock += "</tbody></table>";

            // –í—ã–≤–æ–¥–∏–º –≤—Å–µ –±–ª–æ–∫–∏
            document.getElementById('parkingResultsContent').innerHTML = inputBlock + mainBlock + devBlock + breakdownRequired + breakdownMin + breakdownMax + specialBlock;

            // –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç (—Ñ–æ—Ä–º—É–ª—ã –∏ —Ä–∞—Å—á—ë—Ç—ã)
            let reportHtml = `<pre style=\"background:#f8f9fa;padding:1em;border-radius:8px;margin-top:1em;white-space:pre-wrap;font-size:0.95em;\">${calculator.getFormattedReport()}</pre>`;
            document.getElementById('parkingResultsContent').insertAdjacentHTML('beforeend', reportHtml);
        } catch (error) {
            document.getElementById('parkingResultsContent').innerHTML = '<span style="color:red">–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞: ' + error.message + '</span>';
            console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ—è–Ω–æ–∫:", error);
        }
    }


    




    // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', () => {
        calculateParking();
    });
</script>



</body>
</html>